<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafico ordini futuri</title>
  <style>
    :root{
      --main:#770505;
      --accent:#ffd60a;
      --bg-deep:#0a0a0a;
    }

    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      font-family:Verdana, Geneva, sans-serif;
      background:#050708;
      color:#f5f5f7;
    }

    .chart-root{
      position:relative;
      width:100%;
      height:100%;
      box-sizing:border-box;
      padding:4px 0; /* un filo di respiro verticale */
    }

    canvas{
      position:relative;
      display:block;
      width:100%;
      height:100%;
    }

    .avicoli-bar{
      position:absolute;
      top:6px;
      right:8px;
      display:flex;
      gap:8px;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(0,0,0,0.55);
      color:rgba(245,245,247,0.9);
      font-size:10px;
      line-height:1.2;
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      pointer-events:none;
    }
    .avicoli-bar strong{
      color:#ffd60a;
      font-weight:700;
    }

    @media (max-width:480px){
      .chart-root{padding:2px 0;}
    }
  </style>
</head>
<body>
  <div class="chart-root">
    <canvas id="orders-chart"></canvas>
    <div class="avicoli-bar" id="avicoli-bar">
      <span>Oche: <strong id="tot-oche">—</strong></span>
      <span>Anatre: <strong id="tot-anatre">—</strong></span>
      <span>Caponi: <strong id="tot-caponi">—</strong></span>
      <span>Polli: <strong id="tot-polli">—</strong></span>
    </div>
  </div>

  <script>
    // ========= Utilità base / brand =========
    const API = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';

    const pad = n => String(n).padStart(2,'0');

    function today(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    const norm = s => s?.toString().trim().toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"");

    function parseDate(s){
      if(!s) return null;
      const str = String(s).trim();
      let m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if(m){
        const dd=+m[1], mm=+m[2]-1, yy=+m[3];
        return new Date(yy<100?2000+yy:yy,mm,dd,12,0,0);
      }
      m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m) return new Date(+m[1],+m[2]-1,+m[3],12,0,0);
      const d=new Date(str);
      return isNaN(d.getTime())?null:d;
    }

    function pickKey(obj,cands){
      const ks = Object.keys(obj||{});
      for(const c of cands){
        const k = ks.find(x=>norm(x)===norm(c));
        if(k) return k;
      }
      for(const c of cands){
        const k = ks.find(x=>norm(x).includes(norm(c)));
        if(k) return k;
      }
      return null;
    }

    function rowToOrder(r){
      const nameK = pickKey(r,['NOME CLIENTE','NOME','CLIENTE']),
            dateK = pickKey(r,['DATA ORDINE','DATA','GIORNO']),
            timeK = pickKey(r,['ORA','ORARIO']),
            zoneK = pickKey(r,['ZONA STOCCAGGIO','ZONA','STOCCAGGIO','UBICAZIONE']),
            ordK  = pickKey(r,['NUMERO ORDINE','ORDINE','N° ORDINE','ORD']);

      const name = nameK ? String(r[nameK]||'').trim() : '';
      if(!name) return null;

      const d   = dateK ? parseDate(r[dateK]) : null;
      const t   = timeK ? String(r[timeK]||'').trim() : '';
      const zone= zoneK ? String(r[zoneK]||'').trim() : '';
      const num = ordK ? Number(r[ordK]) : null;
      const dateISO = d
        ? `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
        : today();

      const __normKeys = Object.fromEntries(Object.keys(r).map(k=>[k,norm(k)]));

      return {
        id: (num!=null?num:null),
        number:(num!=null?num:null),
        name,
        date: dateISO,
        time: t,
        zone,
        src: r,
        __normKeys
      };
    }

    // ========= Stato dati correnti =========
    let chartData = [];

    // ========= Canvas / layout lungo e stretto =========
    function getCanvasCtx(){
      const canvas = document.getElementById('orders-chart');
      if(!canvas) return {};
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;

      const parent = canvas.parentElement;
      let w = parent?.clientWidth || 320;
      let h = parent?.clientHeight || 120;

      // mantiene grafico panoramico, basso e largo
      const maxH = w / 3.0;
      if(h > maxH) h = maxH;

      canvas.width  = w*dpr;
      canvas.height = h*dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);

      return {canvas,ctx,width:w,height:h};
    }

    function drawChart(data){
      const {ctx,width,height} = getCanvasCtx();
      if(!ctx||!width||!height) return;

      ctx.clearRect(0,0,width,height);

      const padding = {top:10,right:10,bottom:26,left:32};
      const w = Math.max(10,width  - padding.left - padding.right);
      const h = Math.max(10,height - padding.top  - padding.bottom);

      // background del grafico (glass dark)
      const bgGrad = ctx.createLinearGradient(
        padding.left, padding.top,
        padding.left, padding.top+h
      );
      bgGrad.addColorStop(0,'rgba(255,255,255,0.06)');
      bgGrad.addColorStop(1,'rgba(0,0,0,0.85)');
      ctx.fillStyle = bgGrad;
      ctx.fillRect(padding.left,padding.top,w,h);

      if(!data.length) return;

      const maxCount = Math.max(1,...data.map(d=>d.count));
      const steps = Math.min(maxCount,4);

      // griglia orizzontale
      ctx.strokeStyle='rgba(255,255,255,0.14)';
      ctx.lineWidth=1;
      ctx.beginPath();
      for(let i=0;i<=steps;i++){
        const y=padding.top + h - (h*i/steps);
        ctx.moveTo(padding.left, y+0.5);
        ctx.lineTo(padding.left + w, y+0.5);
      }
      ctx.stroke();

      // label Y
      ctx.fillStyle='rgba(255,255,255,0.75)';
      ctx.font='10px Verdana, sans-serif';
      ctx.textAlign='right';
      ctx.textBaseline='middle';
      for(let i=0;i<=steps;i++){
        const value=Math.round(maxCount*i/steps);
        const y=padding.top + h - (h*i/steps);
        ctx.fillText(String(value), padding.left - 5, y);
      }

      const n=data.length;
      const gap=4;
      const barWidth=Math.max(4,(w-gap*(n+1))/n);

      // barre brand (giallo → rosso Molino)
      data.forEach((d,i)=>{
        const x=padding.left + gap + i*(barWidth+gap);
        const barH=d.count/maxCount*h;
        const y=padding.top + h - barH;

        const grad=ctx.createLinearGradient(0,y,0,y+barH);
        grad.addColorStop(0,'#ffd60a');   // accent
        grad.addColorStop(0.55,'#ffb347'); // warm
        grad.addColorStop(1,'#770505');   // main brand red

        ctx.fillStyle=grad;
        const r=3;
        ctx.beginPath();
        ctx.moveTo(x, y+r);
        ctx.arcTo(x, y, x+barWidth, y, r);
        ctx.arcTo(x+barWidth, y, x+barWidth, y+barH, r);
        ctx.lineTo(x+barWidth, y+barH);
        ctx.lineTo(x, y+barH);
        ctx.closePath();
        ctx.fill();
      });

      // label X (gg/mm)
      ctx.fillStyle='rgba(255,255,255,0.9)';
      ctx.font='9px Verdana, sans-serif';
      ctx.textAlign='center';
      ctx.textBaseline='top';

      data.forEach((d,i)=>{
        const xCenter = padding.left + gap + i*(barWidth+gap) + barWidth/2;
        const [yyyy,mm,dd] = d.date.split('-');
        const label = `${dd}/${mm}`;
        ctx.fillText(label, xCenter, padding.top + h + 6);
      });
    }

    // ========= Aggregazione ordini futuri =========
    function buildFutureDataFromOrders(orders){
      const tdy = today();
      const map = new Map();

      (orders || []).forEach(o=>{
        if(!o.date) return;
        if(o.date >= tdy){ // da oggi in poi
          map.set(o.date,(map.get(o.date)||0)+1);
        }
      });

      const rows = Array.from(map.entries())
        .map(([date,count])=>({date,count}))
        .sort((a,b)=>a.date.localeCompare(b.date));

      return rows; // se vuoto, tieni demo
    }

    const AVICOLI_TYPES = ['oche','anatre','caponi','polli'];

    function computeAvicoliTotals(rows){
      const totals = {oche:0,anatre:0,caponi:0,polli:0};
      if(!Array.isArray(rows) || !rows.length) return totals;

      const keys = Object.keys(rows[0] || {});
      const keyByTipo = {};

      AVICOLI_TYPES.forEach(tipo=>{
        const k = keys.find(k=>norm(k).includes(tipo));
        if(k) keyByTipo[tipo]=k;
      });

      rows.forEach(r=>{
        AVICOLI_TYPES.forEach(tipo=>{
          const k = keyByTipo[tipo];
          if(!k) return;
          const raw = r[k];
          if(raw==null || raw==='') return;
          const num = Number(String(raw).replace(',','.'));
          if(!Number.isFinite(num)) return;
          totals[tipo]+=num;
        });
      });

      return totals;
    }

    function updateAvicoliBar(totals){
      const bar = document.getElementById('avicoli-bar');
      if(!bar) return;

      const map = {
        oche: document.getElementById('tot-oche'),
        anatre: document.getElementById('tot-anatre'),
        caponi: document.getElementById('tot-caponi'),
        polli: document.getElementById('tot-polli')
      };

      if(!totals){
        Object.values(map).forEach(el=>{ if(el) el.textContent='—'; });
        return;
      }

      Object.entries(map).forEach(([tipo,el])=>{
        if(!el) return;
        const v = totals[tipo];
        el.textContent = (typeof v==='number' && v>0) ? String(v) : '0';
      });
    }

    // ========= Fetch da Google Apps Script =========
    async function loadOrdersAndDraw(){
      try{
        const res = await fetch(API+'?&_ts='+Date.now(),{
          cache:'no-store',
          mode:'cors',
          headers:{Accept:'application/json, text/plain, */*'}
        });

        const ct  = (res.headers && res.headers.get('content-type')) || '';
        const raw = await res.text();
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${raw.slice(0,200)}`);

        let data;
        try{
          const looksJson = ct.toLowerCase().includes('json')
            || raw.trim().startsWith('{')
            || raw.trim().startsWith('[');
          if(looksJson) data = JSON.parse(raw);
          else throw new Error('API non JSON ('+ct+')');
        }catch(_){
          const s = raw.search(/[\[{]/),
                eB= raw.lastIndexOf('}'),
                eA= raw.lastIndexOf(']'),
                e = Math.max(eB,eA);
          if(s!==-1 && e>s) data = JSON.parse(raw.slice(s,e+1));
          else throw new Error('Parse JSON fallita');
        }

        let rows=[];
        if(Array.isArray(data)) rows=data;
        else if(Array.isArray(data.rows)) rows=data.rows;
        else if(Array.isArray(data.data)) rows=data.data;
        else if(data && typeof data==='object'){
          const k = Object.keys(data).find(x=>Array.isArray(data[x]) && (data[x].length===0 || typeof data[x][0]==='object'));
          if(k) rows=data[k];
        }
        if(!Array.isArray(rows)) rows=[];

        const orders = rows.map(rowToOrder).filter(Boolean);
        chartData = buildFutureDataFromOrders(orders);
        const avicoliTotals = computeAvicoliTotals(rows);
        updateAvicoliBar(avicoliTotals);
        drawChart(chartData);
      }
      catch(e){
        console.warn('API load error (grafici.html)', e);
        chartData = [];
        updateAvicoliBar(null);
        drawChart(chartData);
      }
    }

    // ========= Integrazione opzionale con pagina parent =========
    window.updateOrdersChart = function(orders){
      chartData = buildFutureDataFromOrders(orders);
      drawChart(chartData);
    };

    // ========= Init =========
    function init(){
      loadOrdersAndDraw();
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    }else{
      init();
    }

    window.addEventListener('resize', ()=>{
      drawChart(chartData);
    });
  </script>
</body>
</html>
