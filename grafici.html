<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafico ordini futuri</title>
  <style>
    :root{
      --main:#770505;
      --accent:#ffd60a;
      --bg-deep:#0a0a0a;
    }

    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      font-family:Verdana, Geneva, sans-serif;
      background:#0a0a0a;
      color:#f5f5f7;
    }

    .chart-root{
      position:relative;
      width:100%;
      height:100%;
      box-sizing:border-box;
      padding:4px 0;
    }

    canvas{
      position:relative;
      z-index:1;
      display:block;
      width:100%;
      height:100%;
    }

    @media (max-width:480px){
      .chart-root{padding:2px 0;}
    }
  </style>
</head>
<body>
  <div class="chart-root">
    <canvas id="orders-chart"></canvas>
  </div>

  <script>
    function todayISO(){
      const d=new Date();
      const pad=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    let chartData = [
      {date:'2025-11-20',count:6},
      {date:'2025-11-21',count:11},
      {date:'2025-11-22',count:4},
      {date:'2025-11-23',count:9},
      {date:'2025-11-24',count:7},
      {date:'2025-11-25',count:14},
      {date:'2025-11-26',count:12},
      {date:'2025-11-27',count:5},
      {date:'2025-11-28',count:10},
      {date:'2025-11-29',count:8}
    ];

    function getCanvasCtx(){
      const canvas=document.getElementById('orders-chart');
      if(!canvas) return {};
      const ctx=canvas.getContext('2d');
      const dpr=window.devicePixelRatio||1;

      const parent=canvas.parentElement;
      let w=parent?.clientWidth||320;
      let h=parent?.clientHeight||120;

      // adattato: usa sempre l'altezza reale del contenitore (flashcard lunga e stretta)
      // if(h > w/2.8) h = w/2.8;

      canvas.width=w*dpr;
      canvas.height=h*dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);

      return {canvas,ctx,width:w,height:h};
    }

    function drawChart(data){
      const {ctx,width,height}=getCanvasCtx();
      if(!ctx||!width||!height) return;

      ctx.clearRect(0,0,width,height);

      const padding={top:4,right:8,bottom:18,left:26};
      const w=Math.max(10,width - padding.left - padding.right);
      const h=Math.max(10,height - padding.top - padding.bottom);

      const bgGrad=ctx.createLinearGradient(
        padding.left, padding.top,
        padding.left, padding.top+h
      );
      bgGrad.addColorStop(0,'rgba(255,255,255,0.05)');
      bgGrad.addColorStop(1,'rgba(0,0,0,0.78)');
      ctx.fillStyle=bgGrad;
      ctx.fillRect(padding.left,padding.top,w,h);

      if(!data.length) return;

      const maxCount=Math.max(1,...data.map(d=>d.count));
      const steps=Math.min(maxCount,4);

      ctx.strokeStyle='rgba(255,255,255,0.12)';
      ctx.lineWidth=1;
      ctx.beginPath();
      for(let i=0;i<=steps;i++){
        const y=padding.top + h - (h*i/steps);
        ctx.moveTo(padding.left, y+0.5);
        ctx.lineTo(padding.left + w, y+0.5);
      }
      ctx.stroke();

      ctx.fillStyle='rgba(255,255,255,0.7)';
      ctx.font='10px Verdana, sans-serif';
      ctx.textAlign='right';
      ctx.textBaseline='middle';
      for(let i=0;i<=steps;i++){
        const value=Math.round(maxCount*i/steps);
        const y=padding.top + h - (h*i/steps);
        ctx.fillText(String(value), padding.left - 5, y);
      }

      const n=data.length;
      const gap=6;
      const barWidth=Math.max(4,(w-gap*(n+1))/n);

      data.forEach((d,i)=>{
        const x=padding.left + gap + i*(barWidth+gap);
        const barH=d.count/maxCount*h;
        const y=padding.top + h - barH;

        const grad=ctx.createLinearGradient(0,y,0,y+barH);
        grad.addColorStop(0,'#ffd60a');
        grad.addColorStop(0.5,'#ffb347');
        grad.addColorStop(1,'#770505');

        ctx.fillStyle=grad;
        const r=4;
        ctx.beginPath();
        ctx.moveTo(x, y+r);
        ctx.arcTo(x, y, x+barWidth, y, r);
        ctx.arcTo(x+barWidth, y, x+barWidth, y+barH, r);
        ctx.lineTo(x+barWidth, y+barH);
        ctx.lineTo(x, y+barH);
        ctx.closePath();
        ctx.fill();
      });

      ctx.fillStyle='rgba(255,255,255,0.85)';
      ctx.font='9px Verdana, sans-serif';
      ctx.textAlign='center';
      ctx.textBaseline='top';

      data.forEach((d,i)=>{
        const xCenter = padding.left + gap + i*(barWidth+gap) + barWidth/2;
        const [yyyy,mm,dd]=d.date.split('-');
        const label=`${dd}/${mm}`;
        ctx.fillText(label, xCenter, padding.top + h + 6);
      });
    }

    function buildFutureDataFromOrders(orders){
      const today = todayISO();
      const map = new Map();

      (orders || []).forEach(o=>{
        if(!o.date) return;
        if(o.date >= today){
          map.set(o.date,(map.get(o.date)||0)+1);
        }
      });

      const rows = Array.from(map.entries())
        .map(([date,count])=>({date,count}))
        .sort((a,b)=>a.date.localeCompare(b.date));

      return rows.length ? rows : chartData;
    }

    window.updateOrdersChart = function(orders){
      chartData = buildFutureDataFromOrders(orders);
      drawChart(chartData);
    };

    function init(){ drawChart(chartData); }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded',init);
    }else{
      init();
    }

    window.addEventListener('resize', ()=>{
      drawChart(chartData);
    });
  </script>
</body>
</html>
