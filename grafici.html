<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafici 2.0</title>
  <style>
    :root{
      --main:#770505;
      --accent:#ffd60a;
      --bg-deep:#0a0a0a;
    }

    html,body{
      margin:0;
      padding:0;
      width:100%;
      min-height:100%;
      overflow:hidden;
      font-family:Verdana, Geneva, sans-serif;
      background:#050708;
      color:#f5f5f7;
    }

    .chart-root{
      position:relative;
      width:100%;
      box-sizing:border-box;
      padding:6px 10px;
      display:flex;
      align-items:stretch;
      justify-content:center;
      background:transparent;
    }

    .chart-layout{
      width:100%;
      display:flex;
      gap:12px;
      padding:8px 10px;
    }

    .chart-main{
      flex:2;
      min-width:0;
      display:flex;
    }

    canvas{
      width:100%;
      height:100%;
    }

    .avicoli-bar{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
      padding:6px 12px;
      font-size:11px;
      line-height:1.3;
    }

    .avicoli-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .avicoli-row-label{opacity:.85;}
    .avicoli-row strong{font-size:14px;font-weight:800;color:#ffd60a;}

    @media(max-width:780px){
      .chart-layout{flex-direction:column;gap:8px;}
      .avicoli-bar{flex-direction:row;justify-content:space-between;}
    }
  </style>
</head>
<body>
  <div class="chart-root">
    <div class="chart-layout">

      <div class="chart-main">
        <canvas id="orders-chart"></canvas>
      </div>

      <aside class="avicoli-bar" id="avicoli-bar">
        <div class="avicoli-row"><span class="avicoli-row-label">Oche</span><strong id="tot-oche">—</strong></div>
        <div class="avicoli-row"><span class="avicoli-row-label">Anatre</span><strong id="tot-anatre">—</strong></div>
        <div class="avicoli-row"><span class="avicoli-row-label">Caponi</span><strong id="tot-caponi">—</strong></div>
        <div class="avicoli-row"><span class="avicoli-row-label">Polli</span><strong id="tot-polli">—</strong></div>
      </aside>

    </div>
  </div>

<script>
// ===== API =====
const API = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';

// ===== Helpers =====
const pad=n=>String(n).padStart(2,'0');
const norm=s=>s?.toString().trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");

function today(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}

function parseDate(s){
  if(!s) return null;
  const str=String(s).trim();
  let m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if(m){return new Date(+m[3]<100?2000+ +m[3]:+m[3],+m[2]-1,+m[1],12,0,0);}  
  m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){return new Date(+m[1],+m[2]-1,+m[3],12,0,0);}  
  const d=new Date(str);
  return isNaN(d.getTime())?null:d;
}

function pickKey(obj,cands){
  const ks=Object.keys(obj||{});
  for(const c of cands){const k=ks.find(x=>norm(x)===norm(c));if(k) return k;}
  for(const c of cands){const k=ks.find(x=>norm(x).includes(norm(c)));if(k) return k;}
  return null;
}

function rowToOrder(r){
  const nameK=pickKey(r,['NOME CLIENTE','NOME','CLIENTE']);
  if(!nameK || !String(r[nameK]).trim()) return null;

  const dateK=pickKey(r,['DATA ORDINE','DATA','GIORNO']);
  const d=dateK?parseDate(r[dateK]):null;
  const dateISO=d?`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`:today();

  return {date:dateISO, src:r};
}

// ===== Avicoli =====
const AVICOLI_TYPES=['oche','anatre','caponi','polli'];

function computeAvicoliTotals(rows){
  const totals={oche:0,anatre:0,caponi:0,polli:0};
  if(!rows) return totals;

  const keys=Object.keys(rows[0]||{});
  const map={};
  AVICOLI_TYPES.forEach(t=>{map[t]=keys.find(k=>norm(k).includes(t));});

  rows.forEach(r=>{
    AVICOLI_TYPES.forEach(t=>{
      const k=map[t]; if(!k) return;
      const v=Number(String(r[k]).replace(",",".")||0);
      if(!isNaN(v)) totals[t]+=v;
    });
  });
  return totals;
}

function updateAvicoliBar(t){
  const ids={oche:'tot-oche',anatre:'tot-anatre',caponi:'tot-caponi',polli:'tot-polli'};
  AVICOLI_TYPES.forEach(tp=>{
    document.getElementById(ids[tp]).textContent = Math.ceil(t[tp]||0);
  });
}

// ===== Grafico =====
let chartData=[];
let chartAnimId=null;

function getCanvasCtx(){
  const c=document.getElementById('orders-chart');
  const ctx=c.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const w=c.clientWidth, h=c.clientHeight;
  c.width=w*dpr; c.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx,w,h};
}

function drawChart(data,progress=1){
  const {ctx,w,h}=getCanvasCtx(); if(!ctx) return;
  ctx.clearRect(0,0,w,h);

  const padL=10, padR=10, padT=8, padB=20;
  const W=w-padL-padR, H=h-padT-padB;

  const maxC=Math.max(1,...data.map(d=>d.count));
  const gap=6;
  const barW=Math.max(4,(W-gap*(data.length+1))/data.length);

  data.forEach((d,i)=>{
    const x=padL + gap + i*(barW+gap);
    const barH=(d.count/maxC*H)*progress;
    const y=padT + (H-barH);

    ctx.fillStyle='#ffd60a';
    ctx.fillRect(x,y,barW,barH);

    ctx.fillStyle='black';
    ctx.font='10px Verdana';
    ctx.textAlign='center';
    ctx.fillText(d.count, x+barW/2, y-2);
  });

  ctx.fillStyle='#ccc'; ctx.font='10px Verdana'; ctx.textAlign='center';
  data.forEach((d,i)=>{
    const x=padL + gap + i*(barW+gap) + barW/2;
    ctx.fillText(d.date.slice(5), x, h-padB+4);
  });
}

function animateChart(data){
  if(chartAnimId) cancelAnimationFrame(chartAnimId);
  const start=performance.now(), dur=450;
  function f(t){
    const k=Math.min(1,(t-start)/dur);
    drawChart(data,k);
    if(k<1) chartAnimId=requestAnimationFrame(f);
  }
  chartAnimId=requestAnimationFrame(f);
}

// ===== Load =====
async function loadOrdersAndDraw(){
  try{
    const res=await fetch(API+'?ts='+Date.now());
    const raw=await res.text();
    const data=JSON.parse(raw.match(/[{\[]([\s\S]*)[}\]]/
