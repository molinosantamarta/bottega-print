<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grafici 2.0</title>
  <style>
    :root{ --accent:#ffd60a; }
    html,body{ margin:0;padding:0;width:100%;height:100%;font-family:Verdana;background:#050708;color:#f5f5f7;overflow:hidden; }
    .wrap{ display:flex;gap:14px;width:100%;height:100%;padding:14px;box-sizing:border-box; }
    .left{ flex:2;min-width:0;display:flex;align-items:center;justify-content:center; }
    .right{ flex:1;display:flex;flex-direction:column;justify-content:center;gap:8px;font-size:13px; }
    .row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;}
    .row strong{color:var(--accent);font-size:18px;font-weight:800;}
    canvas{width:100%;height:100%;border-radius:14px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="left"><canvas id="chart"></canvas></div>
  <div class="right">
    <div class="row"><span>Oche</span><strong id="oche">0</strong></div>
    <div class="row"><span>Anatre</span><strong id="anatre">0</strong></div>
    <div class="row"><span>Caponi</span><strong id="caponi">0</strong></div>
    <div class="row"><span>Polli</span><strong id="polli">0</strong></div>
  </div>
</div>

<script>
// Sandbox-safe fallback mode
// If fetch fails, we use demo data instead of crashing.

const TYPES=["oche","anatre","caponi","polli"];

function draw(data){
  const c=document.getElementById("chart");
  const ctx=c.getContext("2d");
  const w=c.clientWidth,h=c.clientHeight;
  c.width=w; c.height=h;
  ctx.clearRect(0,0,w,h);
  if(!data.length) return;

  const pad=18;
  const W=w-pad*2;
  const H=h-pad*2;
  const max=Math.max(...data.map(d=>d.count));
  const step=W/data.length;
  const bar=step*0.55;

  ctx.font="10px Verdana";
  ctx.textAlign="center";
  ctx.textBaseline="bottom";

  data.forEach((d,i)=>{
    const x=pad+i*step+(step-bar)/2;
    const bh=H*(d.count/max);
    const y=h-pad-bh;

    ctx.fillStyle="#ffd60a";
    ctx.fillRect(x,y,bar,bh);

    ctx.fillStyle="#000";
    ctx.fillText(d.count,x+bar/2,y-3);

    ctx.fillStyle="#ccc";
    ctx.fillText(d.date.slice(5),x+bar/2,h-pad+12);
  });
}

async function load(){
  let rows=null;
  try{
    const res=await fetch("https://script.google.com/macros/s/INVALID_FOR_SANDBOX/exec",{mode:"no-cors"});
    if(!res.ok) throw new Error("fetch blocked");
  }catch(e){
    // DEMO fallback
    rows=[
      {"DATA RITIRO":"2025-11-20", oche:1, anatre:0, caponi:5, polli:2},
      {"DATA RITIRO":"2025-11-21", oche:0, anatre:1, caponi:0, polli:1},
      {"DATA RITIRO":"2025-11-22", oche:2, anatre:0, caponi:0, polli:3}
    ];
  }

  // Compute totals
  const totals={oche:0,anatre:0,caponi:0,polli:0};
  rows.forEach(r=>{
    TYPES.forEach(tp=>{ totals[tp]+=Number(r[tp]||0); });
  });

  document.getElementById("oche").textContent=Math.ceil(totals.oche);
  document.getElementById("anatre").textContent=Math.ceil(totals.anatre);
  document.getElementById("caponi").textContent=Math.ceil(totals.caponi);
  document.getElementById("polli").textContent=Math.ceil(totals.polli);

  // Chart future extraction
  const unique={};
  rows.forEach(r=>{
    const iso=String(r["DATA RITIRO"]);
    unique[iso]=(unique[iso]||0)+1;
  });

  const data=Object.entries(unique).map(([date,count])=>({date,count}));
  draw(data);
}

window.addEventListener("load",load);
window.addEventListener("resize",load);
</script>
</body>
</html>
