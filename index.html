<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ePOS‑Print · MVP minimo</title>
<style>
  html,body{margin:0;background:#0b0e14;color:#e6e8ef;font:16px/1.35 ui-monospace,Menlo,Consolas,monospace}
  .wrap{max-width:680px;margin:0 auto;padding:18px}
  h1{font-size:16px;margin:0 0 12px}
  label{display:block;font-size:12px;color:#9aa3b2;margin:10px 0 6px}
  input,textarea,button{width:100%;box-sizing:border-box}
  input,textarea{background:#0f1219;color:#e6e8ef;border:1px solid #2b3040;border-radius:10px;padding:10px}
  textarea{min-height:90px;white-space:pre}
  .row{display:flex;gap:8px;align-items:center}
  .row>*{flex:1}
  button{appearance:none;border:1px solid #2b3040;background:#1a1f2b;color:#e6e8ef;padding:10px;border-radius:10px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .log{margin-top:12px;background:#0b0e14;border:1px solid #2b3040;border-radius:10px;padding:10px;height:140px;overflow:auto;font-size:12px;color:#c6d3f5}
</style>
</head>
<body>
<div class="wrap">
  <h1>ePOS‑Print · MVP minimo (Epson TM‑m30II)</h1>

  <label>IP stampante</label>
  <input id="ip" value="192.168.0.192" />

  <label>Contenuto (righe: Nome | qty x prezzo)</label>
  <textarea id="txt">Caffè | 1 x 1.20
Brioches | 2 x 1.80
Succo | 1 x 2.50</textarea>

  <div class="row" style="margin-top:8px">
    <button id="btnTest">Stampa TEST</button>
    <button id="btnPrint">Stampa RICEVUTA</button>
  </div>

  <div class="log" id="log" aria-live="polite"></div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const log=(m)=>{const box=$('#log'); const t=new Date().toLocaleTimeString(); box.textContent += (box.textContent?'\n':'')+`[${t}] ${m}`; box.scrollTop=box.scrollHeight};
  const fmt=n=>(Math.round(n*100)/100).toFixed(2);
  const esc=s=>String(s==null?'':s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

  function toEPOSXml(payload){
    const lines = payload.lines||[];
    const total = lines.reduce((s,l)=> s + (l.qty||0)*(l.price||0), 0);
    const body = [
      `<text align="center">${esc(payload.header||'DEMO')}\n</text>`,
      `<text>------------------------------\n</text>`,
      ...lines.map(l=>{
        const name=esc(l.name||'');
        const qty=l.qty>1?` x${l.qty}`:'';
        const tot=fmt((l.qty||0)*(l.price||0));
        const used=(name+qty).length + tot.length; // ~30 col
        return `<text>${name}${qty}${' '.repeat(Math.max(0,30-used))}${tot}\n</text>`;
      }),
      `<text>------------------------------\n</text>`,
      `<text><bold>true</bold>TOTALE${' '.repeat(Math.max(0,30-('TOTALE'.length+('€ '+fmt(total)).length)))}€ ${fmt(total)}\n</text>`,
      `<cut type="feed" />`
    ].join('');
    return `<?xml version="1.0" encoding="utf-8"?>\n<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print">${body}</epos-print>`;
  }

  async function eposPrint(ip, payload){
    const url = `http://${ip}/cgi-bin/epos/service.cgi?devid=local_printer&timeout=60000`;
    const xml = toEPOSXml(payload);
    const res = await fetch(url,{method:'POST',headers:{'Content-Type':'text/xml; charset=utf-8'},body:xml});
    const txt = await res.text();
    log(`POST ${url} → ${res.status} ${res.ok?'OK':'ERR'} | ${txt.substring(0,120)}…`);
  }

  function parseTextarea(str){
    return str.split(/\n+/).map(l=>l.trim()).filter(Boolean).map(l=>{
      const [name, rest] = l.split('|');
      const m = (rest||'').match(/(\d+(?:[\.,]\d+)?)\s*x\s*(\d+(?:[\.,]\d+)?)/);
      return { name:(name||'').trim(), qty: m? parseFloat(m[1].replace(',','.')):1, price: m? parseFloat(m[2].replace(',','.')):0 };
    });
  }

  $('#btnTest').addEventListener('click', async()=>{
    try{
      await eposPrint($('#ip').value.trim(), {header:'Self‑Test · ePOS', lines:[{name:'Riga di prova',qty:1,price:0}]});
      log('Test inviato');
    }catch(err){ log('Errore TEST: '+err.message) }
  });

  $('#btnPrint').addEventListener('click', async()=>{
    try{
      const payload = { header:'Ordine demo', lines: parseTextarea($('#txt').value) };
      await eposPrint($('#ip').value.trim(), payload);
      log('Ricevuta inviata');
    }catch(err){ log('Errore STAMPA: '+err.message) }
  });
})();
</script>
</body>
</html>
