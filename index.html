<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bottega ¬∑ Interfaccia di Stampa</title>
  <style>
    :root{
      --bg:#5b0a0a;           /* pi√π chiaro di #770505 */
      --bg-2:#6a1010;
      --panel:#f8f8f9;
      --ink:#0c0c0d;
      --muted:#70757a;
      --accent:#0a84ff;
      --ok:#22c55e;
      --warn:#ffd60a;
      --danger:#ef4444;
      --radius:18px;
      --ticket-w: 320px;      /* ~78mm in rendering web */
      --ticket-h: 920px;      /* vincolo verticale visuale */
      --gap: 14px;
    }
    html,body{height:100%;background:var(--bg);margin:0;color:#fff;font:15px/1.35 -apple-system,system-ui,Segoe UI,Roboto,sans-serif;-webkit-font-smoothing:antialiased}
    .page{min-height:100%;display:grid;grid-template-columns: 20% 1fr;gap:var(--gap);padding:calc(10px + env(safe-area-inset-top)) var(--gap) calc(14px + env(safe-area-inset-bottom));box-sizing:border-box}
    @media (max-width:1200px){ .page{grid-template-columns: 1fr; grid-auto-rows:auto; } }

    /* Colonna sinistra: SOLO anteprima stampa */
    .left{display:flex;align-items:flex-start;justify-content:center}
    .ticket-wrap{background:var(--panel);color:var(--ink);border-radius:var(--radius);box-shadow:0 14px 36px rgba(0,0,0,.26);border:1px solid rgba(0,0,0,.06);padding:10px;display:flex;align-items:center;justify-content:center; position:sticky; top:12px; }
    .ticket{width:var(--ticket-w);height:var(--ticket-h);background:#fff;color:#000;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.14) inset;padding:14px 12px;overflow:auto; scrollbar-width:thin}

    /* Stile scontrino (placeholder fedele ma neutro) */
    .t-h{ text-align:center; }
    .t-title{font-weight:800;font-size:16px;margin:0;color:#111}
    .t-sub{font-size:12px;margin:2px 0 6px;color:#333}
    .t-kv{font-size:12px;margin:10px 0 8px}
    .t-kv .r{display:flex;justify-content:space-between;gap:6px;margin:2px 0}
    .t-sep{border-top:1px dashed #000; margin:10px 0}
    .t-items{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
    .t-row{display:grid;grid-template-columns:1fr auto auto;gap:6px;margin:2px 0}
    .t-row .qty{width:34px;text-align:right}
    .t-tot{font-weight:800;margin-top:10px}
    .t-note{margin-top:8px;font-size:12px;color:#222}

    /* Colonna destra: controlli e lista */
    .right{display:grid;grid-template-rows:auto auto 1fr;gap:var(--gap)}

    /* Barra comandi */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--panel);color:var(--ink);border-radius:var(--radius);border:1px solid rgba(0,0,0,.06);padding:10px;box-shadow:0 8px 22px rgba(0,0,0,.2)}
    .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:#111;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;transition:transform .06s ease, background .2s ease}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.print{background:var(--accent);color:#fff;border-color:#0a6ad8}

    /* Flashcards KPI */
    .kpis{display:grid;grid-template-columns:repeat(3, minmax(160px, 1fr));gap:10px}
    @media (max-width:1100px){ .kpis{grid-template-columns: 1fr; } }
    .kpi{background:var(--panel);color:var(--ink);border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:12px 14px;box-shadow:0 8px 22px rgba(0,0,0,.2);display:flex;flex-direction:column;gap:6px}
    .kpi h3{margin:0;font-size:12px;font-weight:800;color:#444;letter-spacing:.3px;text-transform:uppercase}
    .kpi .n{font-size:26px;font-weight:900;color:#111}
    .kpi .hint{font-size:12px;color:#666}

    /* Ricerca + lista ordini */
    .panel{background:var(--panel);color:var(--ink);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 8px 22px rgba(0,0,0,.2);padding:12px}
    .search{display:flex;gap:8px;margin-bottom:10px}
    .input{flex:1;border:1px solid #e5e7eb;border-radius:999px;padding:10px 14px;font-size:15px}

    .list{display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 330px);overflow:auto}
    .row{display:grid;grid-template-columns: 70px 1fr auto;gap:10px;align-items:center;background:#fff;border:1px solid #ececec;border-radius:14px;padding:10px}
    .row .ord{font-weight:900;color:#000;background:#f3f4f6;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;min-width:52px;height:32px}
    .row .meta{display:flex;flex-direction:column}
    .row .name{font-weight:800;color:#111}
    .row .sub{font-size:12px;color:#444}
    .pill{display:inline-flex;align-items:center;gap:6px}
    .row .act{display:flex;gap:8px}
    .row .act .mini{padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111;font-weight:800;cursor:pointer}
    .row.printed{opacity:.45;filter:grayscale(.2)}

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="page">
    <aside class="left">
      <div class="ticket-wrap">
        <div id="ticket" class="ticket" role="region" aria-label="Anteprima stampa">
          <div class="t-h">
            <h1 class="t-title">Molino Santa Marta</h1>
            <div class="t-sub" id="t-date">‚Äî</div>
          </div>
          <div class="t-kv" id="t-kv"></div>
          <div class="t-sep"></div>
          <div class="t-items" id="t-items"></div>
          <div class="t-sep"></div>
          <div class="t-tot" id="t-tot"></div>
          <div class="t-note" id="t-note"></div>
        </div>
      </div>
    </aside>

    <main class="right">
      <div class="toolbar">
        <button id="btn-prev" class="btn" aria-label="Ordine precedente">‚óÄÔ∏é Indietro</button>
        <button id="btn-print" class="btn print" aria-label="Stampa ordine">üñ®Ô∏è Stampa</button>
        <button id="btn-next" class="btn" aria-label="Ordine successivo">Avanti ‚ñ∂Ô∏é</button>
        <span id="status" class="muted" style="margin-left:auto"></span>
      </div>

      <section class="kpis" aria-label="Statistiche">
        <div class="kpi"><h3>Totale ordini</h3><div class="n" id="kpi-all">‚Äî</div><div class="hint" id="kpi-all-hint"></div></div>
        <div class="kpi"><h3>Inseriti oggi</h3><div class="n" id="kpi-today">‚Äî</div><div class="hint" id="kpi-today-hint"></div></div>
        <div class="kpi"><h3>Ancora da stampare</h3><div class="n" id="kpi-pending">‚Äî</div><div class="hint" id="kpi-pending-hint"></div></div>
      </section>

      <section class="panel" aria-label="Ricerca e ordini">
        <div class="search">
          <input id="q" class="input" type="search" placeholder="Cerca per nome o numero ordine‚Ä¶" />
          <button id="go" class="btn">Cerca</button>
          <button id="clear" class="btn" title="Pulisci">Pulisci</button>
        </div>
        <div id="list" class="list" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <script>
  ;(() => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
    const pad2 = n => (n<10? '0'+n : ''+n);
    const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const isToday = d => ymd(d) === ymd(new Date());

    let ROWS = [];
    let VIEW = [];
    let idx = 0;

    const printedKey = o => `printed_${o.ord ?? norm(o.name)+'_'+(o.dateKey||'')}`;
    const isPrinted = o => localStorage.getItem(printedKey(o)) === '1';
    const markPrinted = o => localStorage.setItem(printedKey(o),'1');

    function pickKey(obj, cands){
      const ks = Object.keys(obj);
      for(const c of cands){ const k = ks.find(x => norm(x)===norm(c)); if(k) return k; }
      for(const c of cands){ const k = ks.find(x => norm(x).includes(norm(c))); if(k) return k; }
      return null;
    }

    function parseAnyDate(s){
      if(!s) return null; const str=String(s).trim();
      let m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if(m){ const dd=+m[1], mm=+m[2]-1, yy=+m[3]; return new Date(yy<100?2000+yy:yy,mm,dd,12,0,0); }
      m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m){ return new Date(+m[1],+m[2]-1,+m[3],12,0,0); }
      const d=new Date(str); return Number.isNaN(d.getTime())? null : d;
    }

    function mapRowsFromAPI(rows){
      const out=[];
      for(const r of rows){
        const nameKey = pickKey(r,['NOME CLIENTE','NOME','CLIENTE']);
        const dateKeyRaw = pickKey(r,['DATA ORDINE','DATA','GIORNO']);
        const timeKey = pickKey(r,['ORA','ORARIO']);
        const ordKey = pickKey(r,['NUMERO ORDINE','ORDINE','N¬∞ ORDINE','ORD']);
        const noteKey = pickKey(r,['NOTE','RICHIESTE','MESSAGGIO']);
        const itemsStart = Object.keys(r).find(k=>/^\s*1\)/.test(k));
        const name = nameKey ? (r[nameKey]||'').trim() : '';
        if(!name) continue;
        const d = dateKeyRaw ? parseAnyDate(r[dateKeyRaw]) : null;
        const time = timeKey ? String(r[timeKey]||'').trim() : '';
        const ordRaw = ordKey ? r[ordKey] : r.ord;
        const ord = ordRaw!=null ? Number(ordRaw) : null;
        // estrazione items stile 1) 2) 3)
        const items=[];
        if(itemsStart){
          const sorted = Object.keys(r)
            .filter(k=>/^\s*\d+\)/.test(k))
            .sort((a,b)=> parseInt(a) - parseInt(b));
          sorted.forEach(k=>{
            const v = r[k];
            if(v!=null && String(v).trim()!==''){
              // tenta parse "qta x descrizione ‚Äî prezzo"
              const str = String(v).trim();
              let qty=1, desc=str, price="";
              const m = str.match(/^(\d+)\s*x\s*(.+?)(?:\s*-+\s*‚Ç¨?\s*([0-9]+[\.,]?[0-9]*))?$/i);
              if(m){ qty=+m[1]; desc=m[2].trim(); price=m[3]||""; }
              items.push({qty,desc,price});
            }
          });
        }
        out.push({
          ord: Number.isFinite(ord)? ord : null,
          name,
          dateKey: d? ymd(d) : null,
          date: d,
          time,
          note: noteKey ? (r[noteKey]||'').trim() : '',
          items,
          src:r
        });
      }
      // ordinamento base: per data, poi ora, poi nome
      out.sort((a,b)=>{
        if(a.dateKey && b.dateKey && a.dateKey!==b.dateKey) return a.dateKey.localeCompare(b.dateKey);
        if(a.time && b.time){ const c=a.time.localeCompare(b.time); if(c!==0) return c; }
        return a.name.localeCompare(b.name);
      });
      out.forEach((o,i)=>o.__i=i);
      return out;
    }

    function formatTicket(o){
      $('#t-date').textContent = [o.dateKey || '‚Äî', o.time || ''].filter(Boolean).join(' ¬∑ ');
      const kv = [];
      kv.push(rowKV('Ordine', o.ord!=null? '#'+o.ord : '‚Äî'));
      kv.push(rowKV('Cliente', o.name||'‚Äî'));
      $('#t-kv').innerHTML = kv.join('');
      const items = (o.items && o.items.length)? o.items : [{qty:1,desc:'‚Äî',price:''}];
      $('#t-items').innerHTML = items.map(it=>`<div class="t-row"><div>${escapeHtml(it.desc)}</div><div class="qty">${it.qty}</div><div>${it.price? ('‚Ç¨ '+escapeHtml(it.price)) : ''}</div></div>`).join('');
      $('#t-tot').textContent = ''; // il totale reale lo calcoleremo quando avremo un campo certo
      $('#t-note').textContent = o.note? ('Note: '+o.note) : '';
    }

    function rowKV(k,v){ return `<div class="r"><span>${escapeHtml(k)}</span><strong>${escapeHtml(v)}</strong></div>` }
    function escapeHtml(s){ return String(s==null? '' : s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

    function renderList(){
      const host = $('#list');
      const html = VIEW.map(o=>{
        const printed = isPrinted(o);
        return `<div class="row ${printed? 'printed':''}" data-i="${o.__i}">
          <div class="ord">${o.ord ?? '‚Äî'}</div>
          <div class="meta">
            <div class="name">${escapeHtml(o.name)}</div>
            <div class="sub">${[o.dateKey||'‚Äî', o.time||''].filter(Boolean).join(' ¬∑ ')}</div>
          </div>
          <div class="act">
            <button class="mini" data-act="preview">Anteprima</button>
            <button class="mini" data-act="print">Stampa</button>
          </div>
        </div>`;
      }).join('');
      host.innerHTML = html || `<div class="muted">Nessun ordine</div>`;
    }

    function updateKPI(){
      $('#kpi-all').textContent = ROWS.length;
      $('#kpi-all-hint').textContent = ROWS.length? 'Totale in archivio' : '';
      const todayCount = ROWS.filter(r=> r.date && isToday(r.date)).length;
      $('#kpi-today').textContent = todayCount;
      $('#kpi-today-hint').textContent = todayCount? 'Aggiornati ad oggi' : '';
      const pending = ROWS.filter(r=> !isPrinted(r)).length;
      $('#kpi-pending').textContent = pending;
      $('#kpi-pending-hint').textContent = pending? 'Non ancora stampati' : '';
    }

    async function load(){
      setStatus('Carico dati‚Ä¶');
      const res = await fetch(API_URL + '?&_ts=' + Date.now(), { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      ROWS = mapRowsFromAPI(data.rows || []);
      VIEW = [...ROWS];
      idx = Math.max(0, VIEW.findIndex(o=> !isPrinted(o)));
      renderList(); updateKPI();
      if(VIEW[idx]) formatTicket(VIEW[idx]);
      setStatus('');
    }

    function setStatus(msg){ $('#status').textContent = msg; }

    function showIdx(i){ if(!VIEW.length) return; idx = ( (i%VIEW.length) + VIEW.length ) % VIEW.length; formatTicket(VIEW[idx]); ensureRowVisible(VIEW[idx].__i); }
    function ensureRowVisible(i){ const row = $(`.row[data-i="${i}"]`); if(row){ row.scrollIntoView({block:'nearest'}); row.classList.add('pulse'); setTimeout(()=>row.classList.remove('pulse'), 300); } }

    function doSearch(){
      const q = norm( $('#q').value || '' );
      if(!q){ VIEW = [...ROWS]; renderList(); return; }
      if(/^[0-9]+$/.test(q)){ 
        VIEW = ROWS.filter(r=> (r.ord!=null) && String(r.ord).includes(q));
      } else {
        VIEW = ROWS.filter(r=> norm(r.name).includes(q));
      }
      renderList(); if(VIEW[0]){ formatTicket(VIEW[0]); idx = 0; }
    }

    async function doPrint(o){
      // Placeholder: stampa browser. La stampa IP verr√† agganciata dopo.
      window.print();
      markPrinted(o);
      renderList(); updateKPI();
    }

    // Event wiring
    $('#btn-prev').addEventListener('click', ()=> showIdx(idx-1));
    $('#btn-next').addEventListener('click', ()=> showIdx(idx+1));
    $('#btn-print').addEventListener('click', ()=> { const o = VIEW[idx]; if(o) doPrint(o); });

    $('#go').addEventListener('click', doSearch);
    $('#clear').addEventListener('click', ()=>{ $('#q').value=''; VIEW=[...ROWS]; renderList(); if(VIEW[0]){ formatTicket(VIEW[0]); idx=0; } });
    $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    $('#list').addEventListener('click', e=>{
      const btn = e.target.closest('button');
      const row = e.target.closest('.row');
      if(!row) return;
      const i = +row.getAttribute('data-i');
      const o = ROWS.find(r=> r.__i===i);
      if(!o) return;
      if(btn && btn.dataset.act==='preview'){ formatTicket(o); idx = VIEW.findIndex(v=> v.__i===o.__i); }
      if(btn && btn.dataset.act==='print'){ doPrint(o); }
    });

    load().catch(err=>{ setStatus('Errore dati'); console.error(err); });
  })();
  </script>
</body>
</html>
