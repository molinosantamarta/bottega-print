<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39&display=swap" rel="stylesheet">
  <title>Bottega – Stampa Ordini</title>
  <style>
    :root{
      --main:#770505; --fg:#f5f5f7; --card:#ffffff; --ink:#111;
      --radius:22px; --elev:0 10px 24px rgba(0,0,0,.15);
      --gap:14px; --pane-pad:16px;
      --sidebar-w:80%; --preview-w:20%;
      --ticket-max-h:960px; --ticket-w:78mm; /* tipico rotolo 80mm */
    }
    html,body{height:100%;margin:0;background:#f5f5f7;color:#111;font:16px/1.4 -apple-system,system-ui,Segoe UI,Roboto,sans-serif;}
    .app{display:grid;grid-template-columns:minmax(260px, var(--preview-w)) minmax(480px, var(--sidebar-w));gap:var(--gap);height:100%;padding:calc(10px + env(safe-area-inset-top)) calc(10px + env(safe-area-inset-right)) calc(12px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left));box-sizing:border-box;}

    /* Panel base */
    .panel{background:var(--card); color:var(--ink); border-radius:var(--radius); box-shadow:var(--elev); overflow:hidden; border:1px solid rgba(0,0,0,.08);}    

    /* === LEFT: Preview / Ticket === */
    .left{display:flex;flex-direction:column;}
    .ticket-wrap{display:flex;justify-content:center;align-items:flex-start;padding:12px;}
    #ticket{width:var(--ticket-w); max-height:var(--ticket-max-h); background:#fff; color:#000; border:1px solid #e5e5e7; border-radius:12px; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,.12) inset, 0 1px 0 rgba(0,0,0,.08);}    
    .tkt{font:14px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; padding:14px 14px 18px;}
    .tkt .center{text-align:center}
    .tkt .muted{opacity:.85}
    .tkt hr{border:0;border-top:1px dashed #222;margin:10px 0}
    .tkt .h{font-weight:800;letter-spacing:.3px}
    .tkt .row{display:flex;justify-content:space-between;gap:8px}
    .tkt .kv{display:grid;grid-template-columns:88px 1fr;gap:6px 10px}
    .tkt .items{display:grid;grid-template-columns:36px 1fr;gap:6px 8px;margin-top:6px}
    .tkt .foot{margin-top:10px}
    .barcode{font-family:'Libre Barcode 39', cursive; font-size:46px; line-height:1; letter-spacing:1px; margin-top:8px}
    .barcode-num{font-size:12px; opacity:.85; margin-top:2px}

    /* Header bar above ticket */
    .ticket-bar{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px;background:#fafafa;border-bottom:1px solid #eee;position:sticky;top:0;z-index:1}
    .btn{border:none;border-radius:999px;padding:10px 16px;background:var(--main);color:#fff;font-weight:800;cursor:pointer;transition:transform .06s ease, opacity .2s;}
    .btn.secondary{background:#111}
    .btn:active{transform:scale(.985)}

    /* === RIGHT: Controls === */
    .right{display:flex;flex-direction:column;gap:var(--gap)}
    .controls{padding:14px}
    .controls .title{margin:0 0 6px;font-weight:900;font-size:20px;}
    .flashcards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .card{background:#fff;color:#111;border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:12px 14px;box-shadow:var(--elev)}
    .card .k{font-size:12px;opacity:.7}
    .card .v{font-size:42px;font-weight:900;margin-top:4px}

    .searchbar{display:flex;gap:8px;margin-top:12px}
    .input{flex:1;padding:12px 14px;border-radius:999px;border:1px solid #ddd;font-size:16px}
    .list{padding:10px;border-top:1px solid #eee;max-height:calc(100vh - 280px);overflow:auto}
    .order{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;border:1px solid #eee;cursor:pointer;background:#fff}
    .order + .order{margin-top:8px}
    .order:hover{background:#f9f9fb}
    .badge{min-width:42px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:#ffd60a;color:#000;font-weight:900}
    .meta{font-size:12px;opacity:.75}

    /* Responsive: sotto i 1100px porta il layout 30/70, sotto gli 860px verticale */
    @media (max-width:1100px){ :root{ --preview-w:30%; --sidebar-w:70%; } }
    @media (max-width:860px){ .app{grid-template-columns:1fr;}.ticket-bar{position:static}.list{max-height:none} }

    /* Print: solo ticket */
    @media print{
      @page{ size: 78mm auto; margin:0; }
      body{background:#fff}
      .app > .right, .ticket-bar{ display:none !important; }
      .app{display:block;padding:0}
      #ticket{border:0;box-shadow:none;border-radius:0;width:78mm;max-height:none;}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT / PREVIEW 20% -->
    <section class="panel left">
      <div class="ticket-bar">
        <button id="btn-prev" class="btn" aria-label="Ordine precedente">◀︎</button>
        <button id="btn-print" class="btn secondary" aria-label="Stampa">Stampa</button>
        <button id="btn-next" class="btn" aria-label="Ordine successivo">▶︎</button>
      </div>
      <div class="ticket-wrap">
        <div id="ticket" aria-label="Anteprima scontrino">
          <div class="tkt" id="tkt-body">
            <!-- Popolato via JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT / CONTROLS 80% -->
    <aside class="panel right">
      <div class="controls">
        <div class="flashcards">
          <div class="card"><div class="k">Totale ordini</div><div id="fc-total" class="v">—</div></div>
          <div class="card"><div class="k">Inseriti oggi</div><div id="fc-today" class="v">—</div></div>
          <div class="card"><div class="k">Da stampare</div><div id="fc-queue" class="v">—</div></div>
        </div>
        <div class="searchbar">
          <input id="q" class="input" type="search" placeholder="Cerca cliente…" />
          <button id="btn-search" class="btn">Cerca</button>
        </div>
      </div>
      <div class="list" id="orders-list" aria-live="polite"></div>
    </aside>
  </div>

  <script>
    // === Mock dataset (senza prezzi) – sostituire poi con API reali ===
    const todayYMD = ()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`};
    let ORDERS = [];

    // Stato UI
    let index = 0; // indice corrente nella lista filtrata
    let view = [...ORDERS];

    // Helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const pad2 = n => (n<10?"0":"")+n;
    const fmtDateIT = iso => { const d=new Date(iso+"T12:00:00"); return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; };

    function recomputeStats(){
      const total = ORDERS.length;
      const today = ORDERS.filter(o=>o.date===todayYMD()).length;
      const queue = ORDERS.filter(o=>!o.printed).length;
      $('#fc-total').textContent = total;
      $('#fc-today').textContent = today;
      $('#fc-queue').textContent = queue;
    }

    function renderList(list){
      const el = $('#orders-list');
      if(!list.length){ el.innerHTML = '<div class="card">Nessun ordine</div>'; return; }
      el.innerHTML = list.map((o,i)=> `
        <div class="order" data-i="${i}">
          <span class="badge">${o.number ?? '—'}</span>
          <div>
            <div style="font-weight:800">${o.name}</div>
            <div class="meta">${fmtDateIT(o.date)} • ${o.time || ''} ${o.printed? '• già stampato':''}</div>
          </div>
        </div>
      `).join('');
    }

    function renderTicket(o){
      if(!o){ $('#tkt-body').innerHTML = '<div class="center muted">Seleziona un ordine</div>'; return; }
      const lines = o.items.map(it=> `<div class="row"><div>${it.qty}×</div><div>${it.desc}</div></div>`).join('');
      const html = `
        <div class="center h">Molino Santa Marta</div>
        <div class="center muted">Bottega di Casterno</div>
        <hr>
        <div class="kv">
          <div class="muted">Ordine</div><div><b>#${o.number ?? '—'}</b></div>
          <div class="muted">Cliente</div><div>${o.name}</div>
          <div class="muted">Data</div><div>${fmtDateIT(o.date)}</div>
          <div class="muted">Ora</div><div>${o.time || '—'}</div>
          <div class="muted">Numero</div><div>${o.id}</div>
        </div>
        <hr>
        <div class="items">${lines}</div>
        <hr>
        <div class="foot center muted">Grazie – conservare per ritiro</div>
      `;
      $('#tkt-body').innerHTML = html;
    }

    function select(i){
      if(i<0||i>=view.length) return; index=i; renderTicket(view[index]); highlightSelected();}

    function highlightSelected(){
      $$('#orders-list .order').forEach((n, i)=>{ n.style.outline = (i===index)? '2px solid var(--main)' : 'none'; });
    }

    function search(){
      const q = ($('#q').value||'').trim().toLowerCase();
      view = !q ? [...ORDERS] : ORDERS.filter(o=> o.name.toLowerCase().includes(q));
      renderList(view); select(0);
    }

    function next(){ if(index < view.length-1){ select(index+1);} }
    function prev(){ if(index > 0){ select(index-1);} }

    function doPrint(){ window.print(); }

    // === API Google Sheet (mapping minimal) ===
    const API_URL = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';
    const norm = s => String(s||'').toLowerCase().trim();
    function parseAnyDate(s){ if(!s) return null; const str=String(s).trim();
      if(str.indexOf('/')>-1){ const a=str.split('/'); const dd=+a[0], mm=+a[1]-1, yRaw=+a[2]; const yy = yRaw<100?2000+yRaw:yRaw; return new Date(yy,mm,dd,12,0,0); }
      if(str.indexOf('-')>-1){ const a=str.split('-'); return new Date(+a[0],+a[1]-1,+a[2],12,0,0); }
      const d=new Date(str); return isNaN(d.getTime())? null : d; }
    function pickKey(obj, cands){ const ks=Object.keys(obj||{}); for(const c of cands){ const k=ks.find(x=>norm(x)===norm(c)); if(k) return k; } for(const c of cands){ const k=ks.find(x=>norm(x).indexOf(norm(c))>-1); if(k) return k; } return null; }
    function rowToOrder(r){
      const nameKey = pickKey(r,['NOME CLIENTE','NOME','CLIENTE']);
      const dateKey = pickKey(r,['DATA ORDINE','DATA','GIORNO']);
      const timeKey = pickKey(r,['ORA','ORARIO']);
      const ordKey  = pickKey(r,['NUMERO ORDINE','ORDINE','N° ORDINE','ORD']);
      const printedKey = pickKey(r,['STAMPATO','STAMPA','PRINTED']);
      const name = nameKey ? String(r[nameKey]||'').trim() : '';
      if(!name) return null;
      const d   = dateKey ? parseAnyDate(r[dateKey]) : null;
      const t   = timeKey ? String(r[timeKey]||'').trim() : '';
      const num = ordKey  ? Number(r[ordKey]) : null;
      const pv  = printedKey ? String(r[printedKey]||'').trim().toLowerCase() : '';
      const printed = (pv==='si'||pv==='sì'||pv==='y'||pv==='yes'||pv==='true'||pv==='1');
      const items = Object.keys(r).map(k=>String(k).trim()).filter(k=>k.length>2 && k.charAt(1)===')' && k.charAt(0)>='0' && k.charAt(0)<='9').map(k=>({qty:1, desc:String(r[k]||'').trim()})).filter(it=>it.desc!=='');
      const dateISO = d? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : todayYMD();
      return { id:num ?? null, number:num ?? null, name, date: dateISO, time:t, printed, items };
    }
    async function loadData(){
      try{
        const res = await fetch(API_URL + '?&_ts=' + Date.now(), {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const rows = Array.isArray(data.rows)? data.rows : [];
        ORDERS = rows.map(rowToOrder).filter(Boolean);
        view = [...ORDERS];
      }catch(e){
        console.warn('API load error', e);
        ORDERS = [];
        view = [];
      }
    }

    // Init
    (function init(){
      recomputeStats();
      renderList(view);
      select(0);
      $('#btn-search').addEventListener('click', search);
      $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') search(); });
      $('#orders-list').addEventListener('click', (e)=>{ const row=e.target.closest('.order'); if(row){ select(+row.dataset.i); }});
      $('#btn-next').addEventListener('click', next);
      $('#btn-prev').addEventListener('click', prev);
      $('#btn-print').addEventListener('click', doPrint);
    })();
  </script>
</body>
</html>
