<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bottega ‚Äì Interfaccia di Stampa</title>
  <style>
    :root{
      --accent:#770505;
      --bg:#f6f6f7;
      --panel:#ffffff;
      --ink:#0b0b0b;
      --muted:#6b7280;
      --ring:rgba(0,0,0,.06);
      --shadow:0 8px 24px rgba(0,0,0,.12);
      --radius:22px;
      --receipt-max-h:960px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 -apple-system,system-ui,Segoe UI,Roboto,sans-serif}
    .app{min-height:100%;display:grid;grid-template-columns:20% 1fr;gap:18px;padding:18px}
    @media(max-width:1100px){.app{grid-template-columns:1fr;}}

    /* Left: receipt preview */
    .left{position:sticky;top:18px;align-self:start}
    .receipt-wrap{background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;display:flex;justify-content:center}
    .receipt{width:240px;max-height:var(--receipt-max-h);overflow:hidden;background:#fff;color:#000;box-shadow:inset 0 0 0 1px #ddd}

    /* Receipt layout to mimic screenshot */
    .r-topstamp{font-size:10px;text-align:center;padding:6px 8px;border-bottom:1px solid #ccc}
    .r-header{padding:10px 10px 0}
    .r-name{font-weight:800;font-size:22px;text-align:center}
    .r-datephone{margin-top:4px;font-weight:800;text-align:left;display:flex;justify-content:space-between;font-size:14px}
    .r-band{margin-top:8px;background:#111;color:#fff;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;padding:6px 10px}
    .r-band .logo{justify-self:center;font-weight:700;border:1px solid #fff;padding:4px 8px;border-radius:999px;font-size:12px}
    .r-band .left-ico,.r-band .right-ico{display:flex;align-items:center;gap:6px;font-size:14px}
    .r-band .dept{grid-column:1/-1;text-align:center;margin-top:6px;font-size:12px}

    .r-body{min-height:540px;display:flex;align-items:center;justify-content:center;padding:18px 16px 12px;text-align:center}
    .r-body .lines{display:grid;gap:12px}
    .r-sep{border-top:1px solid #bbb}
    .r-footer{padding:14px 10px 18px;text-align:center}
    .r-saluto{font-style:italic;font-weight:800}

    /* Right column */
    .right{display:flex;flex-direction:column;gap:14px}
    .toolbar{display:flex;align-items:center;gap:10px}
    .btn{border:none;border-radius:999px;padding:10px 14px;font-weight:800;background:#111;color:#fff;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:12px 14px;display:flex;flex-direction:column;gap:6px}
    .card .label{font-size:12px;color:var(--muted);font-weight:700}
    .card .value{font-size:28px;font-weight:900;letter-spacing:.2px}

    .search{display:flex;gap:10px}
    .search input{flex:1;padding:12px 14px;border-radius:14px;border:1px solid var(--ring);background:#fff;font-size:14px}

    .list{background:var(--panel);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:10px 8px}
    .row{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06);background:#fff;cursor:pointer}
    .row + .row{margin-top:8px}
    .badge{min-width:42px;height:28px;display:inline-grid;place-items:center;background:#ffd60a;border-radius:999px;font-weight:900}
    .meta{display:flex;gap:8px;flex-wrap:wrap;color:#374151;font-size:12px}
    .meta .pill{background:#eef2f7;border-radius:999px;padding:2px 8px}

    /* print: only receipt */
    @media print{
      body{background:#fff}
      .app{display:block;padding:0}
      .left{position:static}
      .receipt-wrap{box-shadow:none;border:none;padding:0}
      .receipt{width:240px;box-shadow:none}
      .right, .toolbar, .cards, .search, .list{display:none !important}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="left">
      <div class="toolbar" style="justify-content:center;margin-bottom:10px">
        <button class="btn secondary" id="prevBtn" title="Precedente">‚óÄ</button>
        <button class="btn" id="printBtn" title="Stampa">Stampa</button>
        <button class="btn secondary" id="nextBtn" title="Successivo">‚ñ∂</button>
      </div>
      <div class="receipt-wrap">
        <div class="receipt" id="receipt">
          <div class="r-topstamp" id="r-ts">‚Äî</div>
          <div class="r-header">
            <div class="r-name" id="r-name">Nome Cognome</div>
            <div class="r-datephone"><span id="r-date">mer 10 dic</span><span id="r-phone">3334160088</span></div>
            <div class="r-band">
              <div class="left-ico">üçñ <strong id="r-avicolo">SI</strong></div>
              <div class="logo">La Bottega</div>
              <div class="right-ico">üõí <strong id="r-number">7</strong></div>
              <div class="dept" id="r-dept">CARNE, ALTRO</div>
            </div>
          </div>
          <div class="r-body">
            <div class="lines" id="r-lines">
              <div>3 panettoni filippi</div>
              <div>ANATRE: 0,5&nbsp;&nbsp;CAPPONI: 1</div>
              <div>1 cappone a pezzi e 1/2 anatra a pezzi</div>
            </div>
          </div>
          <div class="r-sep"></div>
          <div class="r-footer">
            <div class="r-saluto">Grazie e Buone Feste !</div>
            <div style="height:50px;margin-top:10px;background:repeating-linear-gradient(90deg,#000 0 2px,#fff 2px 4px);"></div>
          </div>
        </div>
      </div>
    </aside>

    <main class="right">
      <div class="cards">
        <div class="card"><div class="label">Totale ordini</div><div class="value" id="k-all">0</div></div>
        <div class="card"><div class="label">Inseriti oggi</div><div class="value" id="k-today">0</div></div>
        <div class="card"><div class="label">Da stampare</div><div class="value" id="k-pending">0</div></div>
      </div>
      <div class="search"><input id="q" placeholder="Cerca ordine‚Ä¶" /></div>
      <div class="list" id="list"></div>
    </main>
  </div>

  <script>
  (function(){
    const API_URL = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';
    const fmt = new Intl.DateTimeFormat('it-IT',{weekday:'short',day:'2-digit',month:'short'});
    const pad2=n=>String(n).padStart(2,'0');
    const ymd=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const norm=s=>(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();

    let ROWS=[]; let IDX=0; let PRINTED=new Set(JSON.parse(localStorage.getItem('printed_ids')||'[]'));

    function parseAnyDate(s){
      if(!s) return null; const t=String(s).trim();
      let m=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/); if(m){const dd=+m[1],mm=+m[2]-1,yy=+m[3];return new Date(yy<100?2000+yy:yy,mm,dd,12)}
      m=t.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m){return new Date(+m[1],+m[2]-1,+m[3],12)}
      const d=new Date(t); return isNaN(d)?null:d;
    }

    function mapRows(arr){
      return arr.map((r,i)=>{
        const name=r['NOME CLIENTE']||r['NOME']||r['CLIENTE']||'';
        const dateRaw=r['DATA ORDINE']||r['DATA']||r['GIORNO'];
        const d=parseAnyDate(dateRaw); const dateKey=d?ymd(d):null; const dateText=d?fmt.format(d).replace('.', ''):'';
        const time=r['ORA']||r['ORARIO']||'';
        const phone=r['TELEFONO']||r['CELL']||'';
        const ord=r['ORDINE']||r['NUMERO ORDINE']||r['ORD']||null;
        const dept=(r['REPARTO']||r['BANCO']||'').toString();
        const avicolo=(r['AVICOLO']||'').toString();
        const cart=(r['CARRELLO']||r['QTA']||'').toString();
        const lines=collectLines(r);
        return {i, name, dateKey, dateText, time, phone, ord, dept, avicolo, cart, lines, src:r};
      });
    }

    function collectLines(r){
      const out=[]; Object.keys(r).forEach(k=>{const v=r[k]; if(/^\s*\d+\)/.test(k)||/^RIGA\s*\d+/i.test(k)){ if(String(v).trim()) out.push(String(v).trim()); }}); 
      if(out.length===0){
        const guess=['NOTE','DESCRIZIONE','RIGHE','ARTICOLI'].find(k=>k in r);
        if(guess&&String(r[guess]).trim()) out.push(String(r[guess]).trim());
      }
      return out;
    }

    async function load(){
      const res=await fetch(API_URL+`?&_ts=${Date.now()}`,{cache:'no-store'});
      const data=await res.json();
      ROWS=mapRows(data.rows||[]);
      refreshUI();
      if(ROWS.length){ selectIndex(0); }
    }

    function refreshUI(){
      const todayKey=ymd(new Date());
      document.getElementById('k-all').textContent=ROWS.length;
      document.getElementById('k-today').textContent=ROWS.filter(r=>r.dateKey===todayKey).length;
      const pending=ROWS.filter(r=>!PRINTED.has(String(r.ord||r.i))).length;
      document.getElementById('k-pending').textContent=pending;
      renderList(ROWS);
    }

    function renderList(rows){
      const box=document.getElementById('list'); box.innerHTML='';
      rows.forEach((r,idx)=>{
        const el=document.createElement('div'); el.className='row'; el.dataset.idx=idx;
        el.innerHTML=`<span class="badge">${r.ord??'‚Äî'}</span><div style="flex:1"><div style="font-weight:800">${r.name||'‚Äî'}</div><div class="meta"><span class="pill">${r.dateText||''}</span>${r.time?`<span class='pill'>${r.time}</span>`:''}</div></div>`;
        el.onclick=()=>selectIndex(idx);
        box.appendChild(el);
      });
    }

    function selectIndex(i){ IDX=Math.max(0,Math.min(ROWS.length-1,i)); fillReceipt(ROWS[IDX]); }

    function fillReceipt(r){
      const ts=new Date().toISOString();
      document.getElementById('r-ts').textContent=ts;
      document.getElementById('r-name').textContent=r?.name||'‚Äî';
      document.getElementById('r-date').textContent=r?.dateText||'';
      document.getElementById('r-phone').textContent=(r?.phone||'').toString();
      document.getElementById('r-avicolo').textContent=(r?.avicolo||'').toString().trim()||'‚Äî';
      document.getElementById('r-number').textContent=(r?.ord??'‚Äî');
      document.getElementById('r-dept').textContent=(r?.dept||'').toString().toUpperCase()||' ';
      const lines=document.getElementById('r-lines');
      lines.innerHTML='';
      (r?.lines?.length?r.lines:['‚Äî']).forEach(t=>{const d=document.createElement('div'); d.textContent=t; lines.appendChild(d);});
    }

    document.getElementById('prevBtn').onclick=()=>selectIndex(IDX-1);
    document.getElementById('nextBtn').onclick=()=>selectIndex(IDX+1);
    document.getElementById('printBtn').onclick=()=>{
      const id=String(ROWS[IDX]?.ord??ROWS[IDX]?.i);
      window.print();
      if(id){ PRINTED.add(id); localStorage.setItem('printed_ids', JSON.stringify([...PRINTED])); refreshUI(); }
    };

    document.getElementById('q').addEventListener('input', e=>{
      const q=norm(e.target.value);
      const rows = q? ROWS.filter(r=>norm(r.name).includes(q) || String(r.ord||'').includes(q)) : ROWS;
      renderList(rows);
    });

    load();
  })();
  </script>
</body>
</html>


